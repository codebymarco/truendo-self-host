<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="/styles/navbar.css" />

    <script>
      window.TruSettings = {
        siteid: "19582bfd-aaf2-43de-b9ab-edd2ec303ada",
        custom_url: "true",
        custom_url_value: "truendo",
        tru_headless: "true",
      };
    </script>
    <script
      id="truendoAutoBlock"
      type="text/javascript"
      src="./truendo/pc/truendo_cmp.pid.js"
    ></script>
    <title>Privacy Settings</title>
    
    <!-- Wien Switch Dependencies -->
    <link
      rel="stylesheet"
      href="https://assets.wien.gv.at/theme/latest/css/wiener-melange.min.css"
    />
    <script
      type="module"
      src="https://assets.wien.gv.at/theme/latest/js/components/Switch/Switch.js"
    ></script>
    
    <style>
      /* Wien Switch Custom Properties */
      :root {
        --switch-background-color: #d9d4d1;
        --switch-background-color--active: #504478;
        --switch-background-knob-color: #ffffff;
        --switch-border-color: #000000;
        --switch-height: 24px;
        --switch-width: 44px;
        --switch-padding: 1px;
        --switch-knob-size: 20px;
      }

      wm-switch {
        font-family: "Source Sans Pro", sans-serif;
        font-size: 1rem;
      }

      /* Hide the Wien Switch label text */
      wm-switch .wm-switch__label {
        display: none !important;
      }

      wm-switch .wm-switch__label-text {
        display: none !important;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }

      body {
        background: #ffffff;
        min-height: 100vh;
        color: #000000;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 20px;
      }

      /* Sticky Action Buttons */
      .action-buttons {
        position: sticky;
        top: 0;
        z-index: 1000;
        display: flex;
        gap: 12px;
        justify-content: center;
        padding: 20px;
        background: #ffffff;
        border-bottom: 2px solid #e0e0e0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .action-buttons button {
        padding: 12px 24px;
        border-radius: 6px;
        border: 2px solid;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        min-width: 140px;
        transition: all 0.2s ease;
      }

      .action-buttons button:first-child {
        background: #ffffff;
        color: #000000;
        border-color: #666666;
      }

      .action-buttons button:first-child:hover {
        background: #f5f5f5;
        border-color: #333333;
      }

      .action-buttons button:nth-child(2) {
        background: #666666;
        color: #ffffff;
        border-color: #666666;
      }

      .action-buttons button:nth-child(2):hover {
        background: #555555;
        border-color: #555555;
      }

      .action-buttons button:nth-child(3) {
        background: #000000;
        color: #ffffff;
        border-color: #000000;
      }

      .action-buttons button:nth-child(3):hover {
        background: #333333;
        border-color: #333333;
      }

      #changes {
        display: none;
        background: #000000;
        color: #ffffff;
        border-color: #000000;
      }

      #changes:hover {
        background: #333333;
        border-color: #333333;
      }

      .page-header {
        text-align: center;
        margin-bottom: 40px;
        padding-top: 20px;
      }

      .page-header h1 {
        font-size: 32px;
        font-weight: 700;
        color: #000000;
        letter-spacing: -0.5px;
        margin-bottom: 12px;
      }

      .page-header p {
        font-size: 16px;
        color: #666666;
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.6;
      }

      /* Privacy ID */
      .privacy-id {
        background: #f8f8f8;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
      }

      .privacy-id-label {
        color: #666666;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .privacy-id-value {
        color: #000000;
        font-size: 14px;
        font-family: "SF Mono", Monaco, "Cascadia Code", monospace;
        word-break: break-word;
        line-height: 1.4;
      }

      /* Policy Links */
      .policy-links {
        background: #f8f8f8;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
      }

      .policy-link {
        font-size: 14px;
        color: #666666;
        margin-bottom: 8px;
        line-height: 1.4;
      }

      .policy-link:last-child {
        margin-bottom: 0;
      }

      .policy-link a {
        color: #000000;
        text-decoration: none;
        border-bottom: 1px solid transparent;
        font-weight: 500;
      }

      .policy-link a:hover {
        border-bottom-color: #000000;
      }

      /* Categories Container */
      #catsServicesContainer {
        margin-bottom: 32px;
      }

      /* Category Styles */
      #catsServicesContainer div {
        background: #ffffff;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 16px;
        transition: border-color 0.2s ease;
      }

      #catsServicesContainer div:hover {
        border-color: #cccccc;
      }

      /* Category Header with Toggle */
      .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      #catsServicesContainer h2 {
        color: #000000;
        font-size: 18px;
        font-weight: 600;
        margin: 0;
        letter-spacing: -0.5px;
      }

      /* Wien Switch Container */
      .wien-switch-container {
        margin-left: 12px;
      }

      /* Necessary category styling */
      .category-necessary wm-switch {
        opacity: 0.5;
        pointer-events: none;
      }

      #catsServicesContainer p {
        color: #666666;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 16px;
      }

      /* Service List */
      #catsServicesContainer ul {
        list-style: none;
      }

      #catsServicesContainer li {
        background: #f8f8f8;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 8px;
        color: #333333;
        font-size: 14px;
        line-height: 1.4;
        transition: all 0.2s ease;
      }

      #catsServicesContainer li:hover {
        background: #f0f0f0;
        border-color: #cccccc;
      }

      /* Cookie Box Styling */
      .cookie-box {
        display: none;
        margin-top: 12px;
        padding: 16px;
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 13px;
        color: #333333;
      }

      .cookie-item {
        padding: 8px 12px;
        margin-bottom: 6px;
        background: #f8f8f8;
        border-radius: 4px;
        border: 1px solid #e0e0e0;
      }

      .cookie-item:last-child {
        margin-bottom: 0;
      }

      /* Service Header */
      .service-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 500;
        cursor: pointer;
        color: #000000;
      }

      .service-arrow {
        margin-left: 8px;
        color: #666666;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <nav>
      <h1>demo</h1>
      <div>
        <a href="/privacy.html">cookie settings</a>
        <a href="/">home</a>
        <a href="/about.html">about</a>
      </div>
    </nav>

    <!-- Fixed Action Buttons at Top -->
    <div class="action-buttons">
      <button type="button" onclick="acceptNecessaryAndRefresh()">
        Necessary Only
      </button>
      <button type="button" onclick="acceptAllAndRefresh()">Accept All</button>
      <button type="button" id="changes" onclick="saveSettingsAndClose()">
        Save Changes
      </button>
    </div>

    <div class="container">
      <div class="page-header">
        <h1>Privacy Settings</h1>
        <p>
          Manage your privacy preferences and cookie settings. You can control
          which categories of cookies and services are enabled for your
          experience.
        </p>
      </div>

      <div class="privacy-id">
        <div class="privacy-id-label">Privacy ID</div>
        <div class="privacy-id-value" id="privacyid">Loading...</div>
      </div>

      <div class="policy-links">
        <div class="policy-link" id="cookiepolicy">
          Loading cookie policy...
        </div>
        <div class="policy-link" id="privacypolicy">
          Loading privacy policy...
        </div>
      </div>

      <div id="catsServicesContainer">
        <p>Loading privacy categories...</p>
      </div>
    </div>

    <script>
      // Track changes made before saving
      let changes = false;
      let myMap = new Map();
      myMap.set("statistics", true);
      myMap.set("marketing", true);
      myMap.set("social_content", true);
      myMap.set("add_features", true);

      function catToggled(cat) {
        let currentValue = myMap.get(cat);
        myMap.set(cat, !currentValue);
        changes = true;
        const panel = document.getElementById("changes");
        if (panel) {
          panel.style.display = "block";
        }
      }

      function saveSettingsAndClose() {
        Truendo.SaveSettingsClosePanel();
        // Refresh page after saving
        setTimeout(() => {
          window.location.reload();
        }, 500);
      }

      function acceptNecessaryAndRefresh() {
        Truendo.acceptNecessaryCookiesOnly();
        // Refresh page after accepting necessary only
        setTimeout(() => {
          window.location.reload();
        }, 500);
      }

      function acceptAllAndRefresh() {
        Truendo.acceptAllCookies();
        // Refresh page after accepting all
        setTimeout(() => {
          window.location.reload();
        }, 500);
      }

      // Display data onto the page
      function displayData() {
        const catsAndServices = Truendo.getCatsAndServices();
        console.log("catsAndServices", catsAndServices);
        if (!catsAndServices) return;

        const container = document.getElementById("catsServicesContainer");
        container.innerHTML = "";

        catsAndServices.forEach((category) => {
          container.appendChild(createCategoryElement(category));
        });
      }

      function createCategoryElement(category) {
        const categoryDiv = createElement("div", {
          className: category.cat === "necessary" ? "category-necessary" : "",
        });

        // Create header with title and toggle
        const headerDiv = createElement("div", {
          className: "category-header",
        });

        const titleElement = createElement("h2", { text: category.name });
        headerDiv.appendChild(titleElement);

        // Add Wien Switch for categories (without label)
        const wmSwitch = createElement("wm-switch", {
          name: `category-${category.cat}`,
          checked: category.state === "active",
          disabled: category.cat === "necessary",
        });

        // Add event listener for non-necessary categories
        if (category.cat !== "necessary") {
          wmSwitch.addEventListener("change", (e) => {
            console.log("category toggled", category);
            Truendo.toggleCat(category);
            catToggled(category.cat);
          });
        }

        headerDiv.appendChild(wmSwitch);
        categoryDiv.appendChild(headerDiv);

        categoryDiv.appendChild(createServicesList(category.services));

        return categoryDiv;
      }

      function createServicesList(services) {
        const serviceList = createElement("ul");

        services.forEach((service) => {
          const serviceItem = createElement("li");

          const header = createElement("div", {
            className: "service-header",
            style: { cursor: "pointer" },
          });
          header.textContent = `${service.name}`;

          const detailBox = createElement("div", {
            className: "cookie-box",
          });

          // Vendor Info
          const vendor = service.vendor;
          if (vendor) {
            detailBox.appendChild(
              createElement("p", {
                text: `Vendor: ${vendor.short_name} (${vendor.company_name})`,
              })
            );
            detailBox.appendChild(
              createElement("p", { text: `Address: ${vendor.company_address}` })
            );
            detailBox.appendChild(
              createElement("p", { text: `Website: ${vendor.website}` })
            );
            detailBox.appendChild(
              createElement("p", {
                html: `Policy: <a href='${vendor.policy_link}' target='_blank'>Privacy Policy</a>`,
              })
            );
          }

          // Service Info
          detailBox.appendChild(
            createElement("p", { text: `Purpose: ${service.purpose_name}` })
          );
          detailBox.appendChild(
            createElement("p", {
              text: `Legal Basis: ${service.legalbasis_id}`,
            })
          );
          detailBox.appendChild(
            createElement("p", { text: `Region: ${service.region}` })
          );
          detailBox.appendChild(
            createElement("p", { text: `Retention: ${service.retention}` })
          );
          detailBox.appendChild(
            createElement("p", {
              text: `Data Types: ${service.datatypes.join(", ")}`,
            })
          );

          // Cookie Info (if any)
          if (Array.isArray(service.cookies) && service.cookies.length > 0) {
            const cookieHeader = createElement("p", { text: "Cookies:" });
            detailBox.appendChild(cookieHeader);

            service.cookies.forEach((cookie) => {
              const cookieItem = createElement("div", {
                className: "cookie-item",
              });
              cookieItem.appendChild(
                createElement("p", { text: `Name: ${cookie.name}` })
              );
              cookieItem.appendChild(
                createElement("p", {
                  text: `Description: ${cookie.description}`,
                })
              ); 
              cookieItem.appendChild(
                createElement("p", {
                  text: `Duration: ${cookie.duration.value} ${cookie.duration.type}`,
                })
              );
              cookieItem.appendChild(
                createElement("p", { text: `Retention: ${cookie.retention}` })
              );
              cookieItem.appendChild(
                createElement("p", { text: `Type: ${cookie.cookie_type}` })
              );
              cookieItem.appendChild(
                createElement("p", {
                  text: `Third Party: ${cookie.third_party}`,
                })
              );
              cookieItem.appendChild(
                createElement("p", { text: `Domain: ${cookie.cookie_domain}` })
              );
              detailBox.appendChild(cookieItem);
            });
          }

          header.addEventListener("click", () => {
            const isOpen = detailBox.style.display === "block";
            detailBox.style.display = isOpen ? "none" : "block";
          });

          serviceItem.appendChild(header);
          serviceItem.appendChild(detailBox);
          serviceList.appendChild(serviceItem);
        });

        return serviceList;
      }

      function createElement(tag, options = {}) {
        const element = document.createElement(tag);

        if (options.text) {
          element.textContent = options.text;
        }

        if (options.html) {
          element.innerHTML = options.html;
        }

        if (options.className) {
          element.className = options.className;
        }

        if (options.style) {
          Object.assign(element.style, options.style);
        }

        if (options.type) {
          element.type = options.type;
        }

        if (options.checked !== undefined) {
          element.checked = options.checked;
        }

        if (options.disabled) {
          element.disabled = options.disabled;
        }

        if (options.name) {
          element.name = options.name;
        }

        if (options.events) {
          Object.entries(options.events).forEach(([event, handler]) => {
            element.addEventListener(event, handler);
          });
        }

        return element;
      }

      function displayCookiePolicyLink(link) {
        const container = document.getElementById("cookiepolicy");
        if (container && link) {
          container.innerHTML = `Cookie Policy: <a href="${link}" target="_blank" rel="noopener noreferrer">${link}</a>`;
        }
      }

      function displayPrivacyPolicyLink(link) {
        const container = document.getElementById("privacypolicy");
        if (container && link) {
          container.innerHTML = `Privacy Policy: <a href="${link}" target="_blank" rel="noopener noreferrer">${link}</a>`;
        }
      }

      // Initialize privacy display
      function initializePrivacyDisplay() {
        // Display Privacy ID
        const container = document.getElementById("privacyid");
        if (container && window.Truendo?.privacyID) {
          const id = window.Truendo.privacyID();
          container.innerHTML = id ? id : "Privacy ID not available";
        }

        // Display policy links
        if (window.Truendo?.displayCookiePolicy) {
          window.Truendo.displayCookiePolicy();
        }
        if (window.Truendo?.displayPrivacyPolicy) {
          window.Truendo.displayPrivacyPolicy();
        }

        // Display categories and services
        displayData();
      }

      // Initialize when page loads
      window.addEventListener("load", function () {
        // Wait a bit for Truendo to fully initialize
        setTimeout(initializePrivacyDisplay, 1000);
      });

      // Fallback initialization if Truendo loads later
      if (window.Truendo) {
        initializePrivacyDisplay();
      }
    </script>
  </body>
</html>